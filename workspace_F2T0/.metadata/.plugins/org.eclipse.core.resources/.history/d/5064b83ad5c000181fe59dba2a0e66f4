package display;

import java.awt.Color;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Image;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.geom.AffineTransform;

import javax.swing.JPanel;

import org.opencv.core.Mat;
import org.opencv.core.Size;
import org.opencv.imgproc.Imgproc;

import main.Main;
import main.SoundSource;


public class SourcePanel extends JPanel implements MouseListener{

	private static final long serialVersionUID = 1L;
	
	protected Main main;
	
	private Mat webcam;
	
	public SourcePanel(Main m){
		main=m;
		webcam=new Mat();
		addMouseListener(this);
	}

	
	public void paintComponent(Graphics g){

		/// draw image camera
		if (Main.CAMERA_CONNECTED){
			Graphics2D g2d = (Graphics2D) g.create();
			AffineTransform at = new AffineTransform();
	        
			Imgproc.resize( main.webcam, webcam, new Size(320,240) );
			
			at.setToRotation(Math.PI, webcam.width()/2, webcam.height()/2);
	        
	        g2d.setTransform(at);
	        Image image = Main.Mat2bufferedImage(webcam);
	        g2d.drawImage(image, -350, -250, this);
		}
		
		// draw joystick position
		g.setColor(Color.gray);
 		g.drawOval(530+(int)(main.x_prev*0.25), 390-(int)(main.y_prev*0.25), 25, 25);
 		g.setColor(Color.white);
 		g.drawOval(530+(int)(main.x*0.25), 390-(int)(main.y*0.25), 25, 25);
 		g.drawLine(542+(int)(main.x*0.25), 402-(int)(main.y*0.25), 542+(int)(main.x*0.25)+(int)main.dx*2, 402-(int)(main.y*0.25)-(int)main.dy*2);
 		g.setColor(Color.red);
 		g.drawOval(530+(int)(main.x_next*0.25), 390-(int)(main.y_next*0.25), 25, 25);
 		
 		
 		// draw sound sources
 		for (int i=0;i<main.soundSources.size();i++){
			g.setColor(Color.magenta);
			g.fillOval(542+(int)(main.soundSources.get(i).px*0.25), 402-(int)(main.soundSources.get(i).py*0.25), 5, 5);
		}
 		
	}

	public void mouseClicked(MouseEvent arg0) {}
	public void mouseEntered(MouseEvent arg0) {}
	public void mouseExited(MouseEvent arg0) {}
	
	public void mousePressed(MouseEvent e) {
		System.out.println(main.x+" ; "+main.y+"  ;  "+e.getX()+" ; "+e.getY()+"    ;   "+(int)(e.getX()-542)*4+" , "+ (int)(-e.getY()+402)*4));
		
		main.soundSources.add(new SoundSource((int)(e.getX()-542)*4, (int)(-e.getY()+402)*4));
	}

	public void mouseReleased(MouseEvent arg0) {}
}